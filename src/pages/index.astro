---
import type {
    HomeEntry,
    ProductCategoryEntryMetaItem,
    ProductEntry,
    ProductGenderEntryMetaItem,
} from '../../bcms/types/ts';
import { productToLite } from '../utils/product';

import Layout from '../layouts/Layout.astro';
import HomePageWrapper from '../components/home-page/PageWrapper';
import { bcmsPrivate } from '../bcms-private';
import { bcmsPublic } from '../bcms-public';

// 1. Obtenemos la entrada de la Home
const home = (await bcmsPrivate.entry.getById('home', 'home')) as HomeEntry;

// 2. Extraemos el meta (con any para evitar bloqueos por el logo personalizado)
const homeMeta = home.meta.en as any;

// 3. Obtenemos productos y géneros
const products = (await bcmsPrivate.entry.getAll('product')) as ProductEntry[];
const productsLite = products.map((e) => productToLite(e));
const genderEntries = await bcmsPrivate.entry.getAll('product-gender');

// 4. Procesamos GÉNEROS (Inyectados en la variable 'categories' para el Wrapper)
const categories = (genderEntries as any[]).map((e) => {
    const meta = e.meta.en;
    
    // Filtramos productos que pertenecen a este género específicamente
    const productsInGender = products.filter((p) => 
        p.meta?.en?.gender?._id === e._id
    );

    // Buscamos una imagen de respaldo (fallback) del primer producto del género
    const fallbackImage = productsInGender[0]?.meta?.en?.gallery?.[0];

    return {
        meta: {
            ...meta,
            // CORRECCIÓN ts(2322): Aseguramos que gallery nunca sea undefined
            gallery: meta.gallery && meta.gallery.length > 0 
                ? meta.gallery 
                : (fallbackImage ? [fallbackImage] : [])
        },
        productsCount: productsInGender.length,
    };
}).filter(item => item.meta.gallery.length > 0); // Evitamos que items sin imagen rompan el sitio

// 5. Configuramos filtros para la tienda (Consolidando Categorías y Géneros)
const filters = {
    categories: products.reduce((acc, e) => {
        e.meta.en?.categories.forEach((i) => {
            if (i.meta.en && !acc.find((c) => c.slug === i.meta.en?.slug)) {
                acc.push(i.meta.en);
            }
        });
        return acc;
    }, [] as ProductCategoryEntryMetaItem[]),
    
    genders: (genderEntries as any[]).map(e => e.meta.en as ProductGenderEntryMetaItem),
};

const clientConfig = bcmsPublic.getConfig();
---

<Layout title={`${homeMeta.seo?.title || homeMeta.title} | 3D Shop`}>
    <HomePageWrapper
        client:load
        bcms={clientConfig}
        meta={homeMeta}
     
        categories={categories as any}
        products={productsLite}
        filters={filters}
    />
</Layout>