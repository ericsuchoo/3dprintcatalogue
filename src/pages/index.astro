---
export const prerender = false;

import Layout from '../layouts/Layout.astro';
import HomePageWrapper from '../components/home-page/PageWrapper';

// 1. DEFINICIÓN DE INTERFACES (Para que TypeScript no dé error)
interface PersonajeD1 {
    id_universo: number;
    id_personaje: number;
    nombre_personaje: string;
    img_personaje: string;
}

interface ProductoD1 {
    id_producto: number;
    nombre_producto: string;
    precio: number;
    descuento: number;
    img_producto: string;
    id_personaje: number;
    id_universo: number;
}

// 2. CONEXIÓN A D1
const runtime = (Astro.locals as any).runtime;
const DB = runtime?.env?.DB;

let personajesD1: PersonajeD1[] = [];
let productosD1: ProductoD1[] = [];

if (DB) {
    try {
        const charRes = await DB.prepare("SELECT * FROM personajes").all();
        personajesD1 = (charRes.results as any) || [];

        const prodRes = await DB.prepare("SELECT * FROM productos").all();
        productosD1 = (prodRes.results as any) || [];
    } catch (e) {
        console.error("Error consultando D1:", e);
    }
}

// 3. MAPEO DE DATOS (Con tipos explícitos para evitar error ts(7006))
const categories = personajesD1.map((p: PersonajeD1) => {
    const productsForThisChar = productosD1.filter((prod: ProductoD1) => prod.id_personaje === p.id_personaje);
    
    return {
        meta: {
            title: p.nombre_personaje,
            slug: p.nombre_personaje.toLowerCase().replace(/\s+/g, '-'),
            gallery: [{ src: p.img_personaje, alt: p.nombre_personaje }]
        },
        productsCount: productsForThisChar.length,
    };
});

const productsLite = productosD1.map((p: ProductoD1) => ({
    title: p.nombre_producto,
    slug: p.nombre_producto.toLowerCase().replace(/\s+/g, '-'),
    price: p.precio,
    discount: p.descuento || 0,
    thumbnail: p.img_producto,
}));

// Configuración simulada para mantener compatibilidad con el componente React
const clientConfig = { apiKey: 'd1-only' }; 
const homeMeta = { 
    title: 'Catálogo 3D', 
    seo: { title: 'DC Impresiones 3D | Tienda de Coleccionables' },
    hero: { title: 'Tu colección cobra vida', gallery: [] } // Agregado para evitar warnings
};
---

<Layout title="Catálogo 3D | DC Impresiones">
    <HomePageWrapper
        client:load
        bcms={clientConfig as any}
        meta={homeMeta as any}
        categories={categories as any}
        products={productsLite as any}
        filters={{ categories: [], genders: [] } as any}
    />
</Layout>