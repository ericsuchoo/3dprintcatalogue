---
import type { ProductEntry, ProductEntryMetaItem } from '../../../../bcms/types/ts';
import { productToLite } from '../../../utils/product';
import Layout from '../../../layouts/Layout.astro';
import ProductPageWrapper from '../../../components/shop/product/PageWrapper';
import { bcmsPrivate } from '../../../bcms-private';
import { bcmsPublic } from '../../../bcms-public';

export async function getStaticPaths() {
    const products = (await bcmsPrivate.entry.getAll('product')) as ProductEntry[];
    return products.map((e) => ({
        params: { slug: e.meta.en?.slug || '' },
    }));
}

const { slug } = Astro.params;
const products = (await bcmsPrivate.entry.getAll('product')) as ProductEntry[];
const entry = products.find((e) => e.meta.en?.slug === slug);

if (!entry || !entry.meta.en) return Astro.redirect('/404');

// Procesamos el producto para obtener la galería inyectada
const productLite = productToLite(entry);

const data = {
    // FUSIONAMOS: Mantenemos todos los nodos originales pero inyectamos la galería rápida
    meta: {
        ...entry.meta.en,
        gallery: productLite.gallery,
    },
    otherProducts: products
        .filter((e) => e.meta.en?.slug !== slug)
        .map((e) => productToLite(e))
        .sort((a, b) => b.date - a.date)
        .slice(0, 4),
};

const clientConfig = bcmsPublic.getConfig();
---

<Layout title={`${productLite.title} - Dino Cat 3D`}>
    <ProductPageWrapper client:load data={data} bcms={clientConfig} />
</Layout>