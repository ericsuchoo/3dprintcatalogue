---
export const prerender = false;

import Layout from '../layouts/Layout.astro';
import HomePageWrapper from '../components/home-page/PageWrapper';

// 1. DEFINICIÓN DE INTERFACES
interface PersonajeD1 {
    id_universo: number;
    id_personaje: number;
    nombre_personaje: string;
    img_personaje: string;
}

interface ProductoD1 {
    id_producto: number;
    nombre_producto: string;
    precio: number;
    descuento: number;
    img_producto: string;
    id_personaje: number;
    id_universo: number;
}

// 2. CONEXIÓN A D1 (Extracción segura)
const runtime = (Astro.locals as any).runtime;
const DB = runtime?.env?.DB;

let personajesD1: PersonajeD1[] = [];
let productosD1: ProductoD1[] = [];

if (DB) {
    try {
        const charRes = await DB.prepare("SELECT * FROM personajes").all();
        personajesD1 = (charRes.results as any) || [];

        const prodRes = await DB.prepare("SELECT * FROM productos").all();
        productosD1 = (prodRes.results as any) || [];
    } catch (e) {
        console.error("Error consultando D1:", e);
    }
}

// 3. MAPEO DE DATOS UNIFICADO
const categories = personajesD1.map((p: PersonajeD1) => {
    const productsForThisChar = productosD1.filter((prod: ProductoD1) => prod.id_personaje === p.id_personaje);
    
    return {
        meta: {
            title: p.nombre_personaje,
            slug: p.nombre_personaje.toLowerCase().replace(/\s+/g, '-'),
            // Estructura de galería compatible con el componente React
            gallery: [
                { 
                    src: p.img_personaje || '/placeholder.webp', 
                    alt: p.nombre_personaje 
                }
            ]
        },
        productsCount: productsForThisChar.length,
    };
});

const productsLite = productosD1.map((p: ProductoD1) => ({
    title: p.nombre_producto,
    slug: p.nombre_producto.toLowerCase().replace(/\s+/g, '-'),
    price: p.precio,
    discount: p.descuento || 0,
    thumbnail: {
        src: p.img_producto || '/placeholder.webp',
        alt: p.nombre_producto
    }
}));

// 4. CONFIGURACIÓN DE MOCK PARA EL WRAPPER
const clientConfig = { apiKey: 'd1-only' }; 
const homeMeta = { 
    title: 'Catálogo 3D', 
    seo: { title: 'DC Impresiones 3D | Tienda de Coleccionables' },
    // Mock del Hero para que la parte superior de la web no salga vacía
    hero: { 
        title: 'Tu colección cobra vida', 
        subtitle: 'Modelos coleccionables de alta calidad impresos en 3D',
        gallery: categories.length > 0 ? categories[0].meta.gallery : [] 
    }
};

// Mock de filtros para que el componente de búsqueda funcione
const filters = {
    categories: categories.map(c => ({ title: c.meta.title, slug: c.meta.slug })),
    genders: [] 
};
---

<Layout title="Catálogo 3D | DC Impresiones">
    <HomePageWrapper
        client:load
        bcms={clientConfig as any}
        meta={homeMeta as any}
        categories={categories as any}
        products={productsLite as any}
        filters={filters as any}
    />
</Layout>