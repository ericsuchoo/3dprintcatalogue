---
import type {
    HomeEntry,
    ProductCategoryEntryMetaItem,
    ProductEntry,
} from '../../bcms/types/ts';
import { productToLite } from '../utils/product';

import Layout from '../layouts/Layout.astro';
import NewPageWrapper from '../components/home-page/PageWrapperfil'; // Usando tu nuevo wrapper mini
import { bcmsPrivate } from '../bcms-private';
import { bcmsPublic } from '../bcms-public';

// 1. Obtenemos la entrada de la Home
const home = (await bcmsPrivate.entry.getById('home', 'home')) as HomeEntry;
const homeMeta = home.meta.en as any;

// 2. Obtenemos los productos (Base de toda nuestra lógica)
const products = (await bcmsPrivate.entry.getAll('product')) as ProductEntry[];
const productsLite = products.map((e) => productToLite(e));

// 3. EXTRAER PERSONAJES DESDE LOS PRODUCTOS (Usando nom_personaje_filt)
// En lugar de hacer getAll de otro template, sacamos los personajes que ya están en los productos
const categories = products.reduce((acc, p) => {
    const pMeta = p.meta.en as any;
    const personajeEntry = pMeta.nom_personaje_filt; // Este es el Entry Pointer

    if (personajeEntry && personajeEntry.meta?.en) {
        const charMeta = personajeEntry.meta.en;
        
        // Evitamos duplicados: Si el personaje ya se agregó al array, no lo repetimos
        if (!acc.find((item) => item.meta.slug === charMeta.slug)) {
            
            // Contamos cuántos productos tienen este mismo ID de personaje
            const productsWithThisChar = products.filter((prod) => 
                (prod.meta.en as any).nom_personaje_filt?._id === personajeEntry._id
            );

            const fallbackImage = pMeta.gallery?.[0];

            acc.push({
                meta: {
                    ...charMeta,
                    // Prioridad: Imagen del template Personaje > Imagen del primer producto que lo usa
                    gallery: charMeta.gallery && charMeta.gallery.length > 0 
                        ? charMeta.gallery 
                        : (fallbackImage ? [fallbackImage] : [])
                },
                productsCount: productsWithThisChar.length,
            });
        }
    }
    return acc;
}, [] as any[]);

// 4. Configuramos filtros para el Wrapper
const filters = {
    categories: products.reduce((acc, e) => {
        e.meta.en?.categories.forEach((i) => {
            if (i.meta.en && !acc.find((c) => c.slug === i.meta.en?.slug)) {
                acc.push(i.meta.en);
            }
        });
        return acc;
    }, [] as ProductCategoryEntryMetaItem[]),
    
    // Inyectamos los personajes extraídos como el filtro principal
    personajes: categories.map(c => c.meta),
};

const clientConfig = bcmsPublic.getConfig();
---

<Layout title={`Explorar Personajes | 3D Shop`}>
    <NewPageWrapper
        client:load
        bcms={clientConfig}
        meta={homeMeta}
        categories={categories as any}
        products={productsLite}
        filters={filters}
    />
</Layout>